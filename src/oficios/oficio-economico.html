<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generador Oficio Econ贸mico</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue 3 (CDN) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <!-- pdf-lib -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen relative">
  <script>
    // Verificar autenticaci贸n
    const urlParams = new URLSearchParams(window.location.search);
    const fromPanel = urlParams.get('from') === 'panel';
    const isAuthenticated = sessionStorage.getItem("loggedIn") === "true";

    // Si no viene del panel y no est谩 autenticado, redirigir al login
    if (!fromPanel && !isAuthenticated) {
      window.location.href = "../../index.html";
    }

    // Si viene del panel, establecer la sesi贸n
    if (fromPanel) {
      sessionStorage.setItem("loggedIn", "true");
    }
  </script>
  <div id="app" class="w-full flex justify-center">
    <!-- Contenedor principal -->
    <div class="flex flex-col md:flex-row w-11/12 max-w-6xl bg-white rounded-xl shadow-lg overflow-hidden">
      <!-- Panel de formulario -->
      <div class="flex-1 flex flex-col items-center justify-center p-8 relative">
        <img src="/assets/images/logo.png" alt="Logo" class="mb-6 md:hidden w-32 h-auto" />

        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 text-center mb-4">
          Oficio Econ贸mico
        </h2>
        <p class="text-gray-600 text-center mb-6 text-sm md:text-base">
          COLABORACIN ECONMICA PARA CELEBRACIN DEL LXI (61 a帽os) ANIVERSARIO
          DE FIESTA PATRONAL EN HONOR A "NUESTRA SEORA VIRGEN DE ANGOSTO"
        </p>

        <div class="w-full max-w-md">
          <label for="nombre" class="block font-semibold text-gray-700 mb-2 text-left">Ingresa el nombre de la
            persona:</label>
          <input v-model="nombre" type="text" id="nombre" placeholder="Ej: JUAN PREZ GMEZ"
            @input="nombre = $event.target.value.toUpperCase()"
            class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500 mb-4" />

          <button @click="generarPDF" :disabled="!nombre.trim()"
            class="w-full py-3 bg-teal-600 text-white font-bold rounded-lg disabled:bg-gray-400 hover:bg-teal-700 transition mb-2">
            Generar Oficio
          </button>

          <!-- Bot贸n Volver al panel -->
          <a href="../../panel.html"
            class="block w-full py-3 text-center text-blue-600 font-bold rounded-lg bg-blue-100 hover:bg-blue-200 transition">
            Volver al Panel
          </a>

          <div v-if="successMsg" class="mt-4 p-3 bg-green-100 text-green-800 font-semibold rounded-lg text-center">
            隆El oficio se gener贸 correctamente! Revisa tus descargas y comp谩rtelo.
          </div>
        </div>
      </div>

      <!-- Imagen lateral para desktop -->
      <div class="hidden md:block md:flex-1">
        <img src="/assets/images/fondo.jpg" alt="Fondo" class="w-full h-full object-cover" />
      </div>
    </div>

    <!-- Loading overlay -->
    <div v-if="loading"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-xl font-bold z-50">
      Generando oficio...
    </div>
  </div>

  <script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
      setup() {
        const nombre = ref("");
        const successMsg = ref(false);
        const loading = ref(false);

        function logout() {
          sessionStorage.removeItem("loggedIn");
          window.location.href = "/index.html";
        }

        async function generarPDF() {
          const nombreFinal = (nombre.value || "Nombre no ingresado").toUpperCase();
          let numeroAleatorio = Math.floor(Math.random() * 900) + 100;
          let numeroOficio = numeroAleatorio.toString().padStart(4, "0");

          try {
            loading.value = true;

            const url = "/src/plantillas/plantilla-oficio-economico.pdf";
            const existingPdfBytes = await fetch(url).then((res) => res.arrayBuffer());

            const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
            const pages = pdfDoc.getPages();
            const firstPage = pages[0];


            firstPage.drawText(nombreFinal, {
              x: 159,
              y: 511,
              size: 10,
              color: PDFLib.rgb(0, 0, 0),
              font: await pdfDoc.embedFont(PDFLib.StandardFonts.TimesRomanBold),
            });

            firstPage.drawText(`OFICIO N掳 ${numeroOficio}-2025-OEC-CFP-NSVA-HB`, {
              x: 90,
              y: 530, //530
              size: 10,
              color: PDFLib.rgb(0, 0, 0),
              font: await pdfDoc.embedFont(PDFLib.StandardFonts.TimesRomanBold),
            });

            //  Dibuja la rejilla de referencia (debug)
            /*     for (let i = 50; i < 600; i += 50) {
                  // eje X
                  firstPage.drawText(i.toString(), {
                    x: i,
                    y: 10,
                    size: 8,
                    color: PDFLib.rgb(1, 0, 0),
                  });
                  // eje Y
                  firstPage.drawText(i.toString(), {
                    x: 10,
                    y: i,
                    size: 8,
                    color: PDFLib.rgb(0, 0, 1),
                  });
                } */

            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: "application/pdf" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `OFICIO N掳 ${numeroOficio}-2025-OEC-CFP-NSVA-HB.pdf`;
            link.click();

            nombre.value = "";
            successMsg.value = true;
            setTimeout(() => (successMsg.value = false), 5000);
          } catch (err) {
            alert("Ocurri贸 un error al generar el PDF.");
            console.error(err);
          } finally {
            setTimeout(() => (loading.value = false), 2000);
          }
        }

        return { nombre, successMsg, loading, logout, generarPDF };
      },
    }).mount("#app");
  </script>
</body>

</html>