<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generador Oficio Espec칤fico</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 (CDN) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- pdf-lib -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen relative">
    <script>
        // Verificar autenticaci칩n
        const urlParams = new URLSearchParams(window.location.search);
        const fromPanel = urlParams.get('from') === 'panel';
        const isAuthenticated = sessionStorage.getItem("loggedIn") === "true";

        // Si no viene del panel y no est치 autenticado, redirigir al login
        if (!fromPanel && !isAuthenticated) {
            window.location.href = "../../index.html";
        }

        // Si viene del panel, establecer la sesi칩n
        if (fromPanel) {
            sessionStorage.setItem("loggedIn", "true");
        }
    </script>
    <div id="app" class="w-full flex justify-center">
        <!-- Contenedor principal -->
        <div class="flex flex-col md:flex-row w-11/12 max-w-6xl bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- Panel de formulario -->
            <div class="flex-1 flex flex-col items-center justify-center p-8 relative">
                <img src="/assets/images/logo.png" alt="Logo" class="mb-6 md:hidden w-32 h-auto" />

                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 text-center mb-4">
                    Oficio Espec칤fico
                </h2>
                <p class="text-gray-600 text-center mb-6 text-sm md:text-base">
                    COLABORACI칍N ESPEC칈FICA PARA CELEBRACI칍N DEL LXI (61 a침os) ANIVERSARIO
                    DE FIESTA PATRONAL EN HONOR A "NUESTRA SE칌ORA VIRGEN DE ANGOSTO"
                </p>

                <div class="w-full max-w-md">
                    <label for="nombre" class="block font-semibold text-gray-700 mb-2 text-left">Ingresa el nombre de la
                        persona:</label>
                    <input v-model="nombre" type="text" id="nombre" placeholder="Ej: JUAN P칄REZ G칍MEZ"
                        @input="nombre = $event.target.value.toUpperCase()"
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500 mb-4" />

                    <label for="asunto" class="block font-semibold text-gray-700 mb-2 text-left">Escribe la
                        colaboraci칩n que deseas solicitar a {{ nombre }}:</label>
                    <textarea v-model="asunto" id="asunto"
                        placeholder="Ej: TOLDEADO DEL FRONTIS DE LA IGLESIA A REALIZARSE DEL S츼BADO 27 AL LUNES 29 DE SEPTIEMBRE"
                        @input="asunto = $event.target.value.toUpperCase().slice(0, 164)" maxlength="164"
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500 mb-4"
                        rows="3"></textarea>
                    <div class="text-right text-sm text-gray-500 mb-4">{{ asunto.length }}/164 caracteres</div>

                    <button @click="generarPDF" :disabled="!nombre.trim()"
                        class="w-full py-3 bg-teal-600 text-white font-bold rounded-lg disabled:bg-gray-400 hover:bg-teal-700 transition mb-2">
                        Generar Oficio
                    </button>

                    <!-- Bot칩n Volver al panel -->
                    <a href="../../panel.html"
                        class="block w-full py-3 text-center text-blue-600 font-bold rounded-lg bg-blue-100 hover:bg-blue-200 transition">
                        Panel de Oficios
                    </a>

                    <div v-if="successMsg"
                        class="mt-4 p-3 bg-green-100 text-green-800 font-semibold rounded-lg text-center">
                        춰El oficio se gener칩 correctamente! Revisa tus descargas y comp치rtelo.
                    </div>
                </div>
            </div>

            <!-- Imagen lateral para desktop -->
            <div class="hidden md:block md:flex-1">
                <img src="/assets/images/fondo.jpg" alt="Fondo" class="w-full h-full object-cover" />
            </div>
        </div>

        <!-- Loading overlay -->
        <div v-if="loading"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-xl font-bold z-50">
            Generando oficio...
        </div>
    </div>
    <script>
        const { createApp, ref } = Vue;

        createApp({
            setup() {
                const nombre = ref("");
                const asunto = ref("");
                const successMsg = ref(false);
                const loading = ref(false);

                function logout() {
                    sessionStorage.removeItem("loggedIn");
                    window.location.href = "/index.html";
                }

                async function generarPDF() {
                    const nombreFinal = (nombre.value || "Nombre no ingresado").toUpperCase();
                    const asuntoFinal = (asunto.value || "Asunto no ingresado").toUpperCase();
                    const colaboracionFinal = asuntoFinal;
                    let numeroAleatorio = Math.floor(Math.random() * 900) + 100;
                    let numeroOficio = numeroAleatorio.toString().padStart(4, "0");

                    try {
                        loading.value = true;

                        const url = "/src/plantillas/plantilla-oficio-especifico.pdf";
                        const existingPdfBytes = await fetch(url).then(res => res.arrayBuffer());
                        const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
                        const pages = pdfDoc.getPages();
                        const firstPage = pages[0];

                        const font = await pdfDoc.embedFont(PDFLib.StandardFonts.TimesRomanBold);

                        // Funci칩n para dibujar texto con flujo natural y ajuste autom치tico al ancho
                        function drawTextFlow(text, x, yStart, maxWidth, lineHeight = 12) {
                            const paragraphs = text.split(/\r?\n/); // separar por p치rrafos
                            let y = yStart;

                            paragraphs.forEach(paragraph => {
                                const words = paragraph.split(/\s+/);
                                let line = "";

                                words.forEach((word, index) => {
                                    const testLine = line ? line + " " + word : word;
                                    const textWidth = font.widthOfTextAtSize(testLine, 10);

                                    if (textWidth > maxWidth) {
                                        // dibuja la l칤nea actual
                                        firstPage.drawText(line, { x, y, size: 10, font, color: PDFLib.rgb(0, 0, 0) });
                                        line = word; // iniciar nueva l칤nea
                                        y -= lineHeight;
                                    } else {
                                        line = testLine;
                                    }

                                    // 칰ltima palabra de p치rrafo
                                    if (index === words.length - 1) {
                                        firstPage.drawText(line, { x, y, size: 10, font, color: PDFLib.rgb(0, 0, 0) });
                                        y -= lineHeight;
                                    }
                                });

                                // espacio extra entre p치rrafos
                                y -= lineHeight / 2;
                            });
                        }

                        // Dibujar nombre y oficio
                        firstPage.drawText(`OFICIO N춿 ${numeroOficio}-2025-OES-CFP-NSVA-HB`, {
                            x: 90,
                            y: 557,
                            size: 10,
                            color: PDFLib.rgb(0, 0, 0),
                            font,
                        });

                        firstPage.drawText(nombreFinal, {
                            x: 159,
                            y: 540,
                            size: 10,
                            color: PDFLib.rgb(0, 0, 0),
                            font,
                        });

                        // Dibujar colaboraci칩n con flujo natural
                        drawTextFlow(asuntoFinal, 130, 522, 400);
                        drawTextFlow(colaboracionFinal, 90, 316, 430);

                        // 游녤 Dibuja la rejilla de referencia (debug)
                        /*    for (let i = 50; i < 600; i += 50) {
                               // eje X
                               firstPage.drawText(i.toString(), {
                                   x: i,
                                   y: 10,
                                   size: 8,
                                   color: PDFLib.rgb(1, 0, 0),
                               });
                               // eje Y
                               firstPage.drawText(i.toString(), {
                                   x: 10,
                                   y: i,
                                   size: 8,
                                   color: PDFLib.rgb(0, 0, 1),
                               });
                           } */

                        // Guardar PDF
                        const pdfBytes = await pdfDoc.save();
                        const blob = new Blob([pdfBytes], { type: "application/pdf" });
                        const link = document.createElement("a");
                        link.href = URL.createObjectURL(blob);
                        link.download = `OFICIO N춿 ${numeroOficio}-2025-OES-CFP-NSVA-HB.pdf`;
                        link.click();

                        nombre.value = "";
                        asunto.value = "";
                        successMsg.value = true;
                        setTimeout(() => (successMsg.value = false), 5000);

                    } catch (err) {
                        alert("Ocurri칩 un error al generar el PDF.");
                        console.error(err);
                    } finally {
                        setTimeout(() => (loading.value = false), 2000);
                    }
                }

                return { nombre, asunto, successMsg, loading, logout, generarPDF };
            },
        }).mount("#app");
    </script>


</body>

</html>